<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Panier - MarcShop</title>
    <link rel="stylesheet" href="styles.css">
    <script src="https://www.paypal.com/sdk/js?client-id=ActOWDtEW7VcCkWDjChLthGFW3vlmi_AnhWBjGEk2nL7hYsCQ6O03H64tDXX6PliIW39E-OgIx1XQypx&components=buttons"></script>
</head>
<body>
    <header>
        <div class="logo">MarcShop</div>
        <input type="text" id="search-bar" placeholder="Rechercher un produit...">
        <nav>
            <a href="paiement.html">Paiement</a>
            <a href="index.html">Accueil</a>
            <a href="suivie.html">Suivi</a>
        </nav>
    </header>
    <h1>Votre Panier</h1>

    <!-- Indicateur de nombre de produits dans le panier -->
    <div id="panier-indicateur">
        <p>Produits dans le panier : <span id="panier-count">0</span></p>
    </div>

    <!-- Section des produits -->
    <div id="produits"></div>

    <!-- Section du panier -->
    <div id="panier-container"></div>

    <!-- Montant total -->
    <div id="montant-total">
        <p><strong>Total : </strong><span id="total-panier">0$</span></p>
    </div>

    <!-- Boutons de gestion du panier -->
    <button id="btn-payer" onclick="redirigerVersPaiement()">Payer</button>
    <button id="btn-vider" onclick="viderPanier()">Vider le panier</button>
    <button id="btn-valider-commande" onclick="validerCommande()">Valider la commande</button>

    <!-- Conteneur du bouton PayPal -->
    <div id="paypal-button-container" style="display:none;"></div>

    <script>
    document.addEventListener("DOMContentLoaded", () => {
        let panier = JSON.parse(localStorage.getItem("panier")) || [];
        const panierContainer = document.getElementById("panier-container");
        const totalPanierElement = document.getElementById("total-panier");
        const panierCountElement = document.getElementById("panier-count");
        const paypalContainer = document.getElementById("paypal-button-container");

        function afficherPanier() {
            if (!panierContainer || !totalPanierElement || !panierCountElement || !paypalContainer) {
                console.error("Un ou plusieurs éléments DOM sont introuvables.");
                return;
            }

            panierContainer.innerHTML = "";
            if (panier.length === 0) {
                panierContainer.innerHTML = "<p>Votre panier est vide.</p>";
                paypalContainer.style.display = "none";
                totalPanierElement.textContent = "0$";
                panierCountElement.textContent = "0";
                return;
            }

            panier.forEach((produit, index) => {
                let div = document.createElement("div");
                div.classList.add("produit-panier");
                div.innerHTML = `
                    <img src="${produit.image}" alt="${produit.nom}" class="produit-image">
                    <div class="details">
                        <h3>${produit.nom}</h3>
                        <p><strong>${produit.prix.toFixed(2)} $</strong></p>
                        <button onclick="supprimerProduit(${index})">Retirer</button>
                    </div>
                `;
                panierContainer.appendChild(div);
            });

            panierCountElement.textContent = panier.length;
            calculerTotal();
            afficherPaypalButton();
        }

        function calculerTotal() {
            if (!totalPanierElement) return "0";
            let total = panier.reduce((sum, produit) => sum + parseFloat(produit.prix), 0);
            totalPanierElement.textContent = `${total.toFixed(2)} $`;
            return total.toFixed(2);
        }

        function supprimerProduit(index) {
            panier.splice(index, 1);
            localStorage.setItem("panier", JSON.stringify(panier));
            afficherPanier();
        }

        function afficherPaypalButton() {
            if (!paypalContainer) return;
            if (panier.length === 0) return;

            paypalContainer.style.display = "block";
            paypalContainer.innerHTML = "";

            paypal.Buttons({
                createOrder: function(data, actions) {
                    return actions.order.create({
                        purchase_units: [{
                            amount: { value: calculerTotal() }
                        }]
                    });
                },
                onApprove: function(data, actions) {
                    return actions.order.capture().then(function(details) {
                        alert("Paiement réussi ! Merci " + details.payer.name.given_name);
                        localStorage.removeItem("panier");
                        window.location.href = "index.html";
                    });
                },
                onError: function(err) {
                    console.error("Erreur de paiement :", err);
                    alert("Une erreur est survenue lors du paiement.");
                }
            }).render('#paypal-button-container');
        }

        afficherPanier();
    });
    </script>
</body>
</html>
